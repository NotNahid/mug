<!--
================================================================================
  3D CERAMIC MUG PREVIEW
================================================================================
  FILE STRUCTURE:
  /your-folder/
    ├── index.html    (this file)
    └── image.png     (your mug design - 2700x1200px recommended)

  RUN WITH LOCAL SERVER:
    - VS Code: Live Server extension
    - Python:  python -m http.server 8000
    - Node:    npx serve .
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Mug Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #e8e4df; overflow: hidden; height: 100vh; width: 100vw;
            touch-action: none;
        }
        #toolbar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 10px 16px;
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
        }
        #toolbar h1 {
            font-size: 15px; font-weight: 700; color: #1a1a1a;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .toolbar-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 14px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 500; cursor: pointer;
            transition: all 0.15s ease; white-space: nowrap;
        }
        .btn-dark { background: #1a1a1a; color: #fff; }
        .btn-dark:hover { background: #333; }
        .btn-dark:active { transform: scale(0.97); }
        .btn svg { width: 16px; height: 16px; flex-shrink: 0; }
        #file-input { display: none; }
        .toggle-wrap {
            display: flex; align-items: center; gap: 6px;
            padding: 4px 10px; background: rgba(0,0,0,0.05); border-radius: 8px;
        }
        .toggle-wrap span { font-size: 12px; font-weight: 500; color: #555; }
        .toggle { position: relative; width: 40px; height: 22px; cursor: pointer; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-track {
            position: absolute; inset: 0; background: #1a1a1a;
            border-radius: 11px; transition: background 0.25s;
        }
        .toggle-track::before {
            content: ''; position: absolute; width: 16px; height: 16px;
            left: 3px; top: 3px; background: #fff; border-radius: 50%;
            transition: transform 0.25s;
        }
        .toggle input:checked + .toggle-track { background: #4CAF50; }
        .toggle input:checked + .toggle-track::before { transform: translateX(18px); }
        #bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0,0,0,0.08);
            padding: 10px 16px;
            display: flex; align-items: center; gap: 10px;
        }
        #bottom-bar label { font-size: 12px; font-weight: 500; color: #555; white-space: nowrap; }
        #bottom-bar input[type="range"] {
            flex: 1; -webkit-appearance: none; appearance: none;
            height: 4px; border-radius: 2px; background: #ccc; outline: none;
        }
        #bottom-bar input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: #1a1a1a; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        #bottom-bar input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%;
            background: #1a1a1a; border: 2px solid #fff; cursor: pointer;
        }
        #bottom-bar .val { font-size: 12px; font-weight: 600; color: #333; min-width: 34px; text-align: right; }
        #canvas-container { width: 100vw; height: 100vh; }
        canvas { display: block; touch-action: none; }
        #toast {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 8px 18px;
            border-radius: 8px; font-size: 13px; pointer-events: none;
            opacity: 0; transition: opacity 0.4s; z-index: 50; white-space: nowrap;
        }
        #toast.show { opacity: 1; }
        #loading {
            position: fixed; inset: 0; z-index: 200;
            display: flex; align-items: center; justify-content: center;
            background: rgba(232,228,223,0.8);
        }
        #loading.hidden { display: none; }
        .spin {
            width: 32px; height: 32px; border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #1a1a1a; border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 600px) {
            #toolbar { padding: 8px 10px; }
            #toolbar h1 { font-size: 13px; }
            .btn { padding: 7px 10px; font-size: 12px; }
            .toggle-wrap span { font-size: 11px; }
            #bottom-bar { padding: 8px 12px; }
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <h1>3D Mug Preview</h1>
        <div class="toolbar-right">
            <div class="toggle-wrap">
                <span>Magic</span>
                <label class="toggle">
                    <input type="checkbox" id="magic-toggle" checked>
                    <span class="toggle-track"></span>
                </label>
            </div>
            <button class="btn btn-dark" onclick="document.getElementById('file-input').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload
            </button>
            <input type="file" id="file-input" accept="image/png,image/jpeg,image/webp">
        </div>
    </div>

    <div id="bottom-bar">
        <label>Offset</label>
        <input type="range" id="offset-slider" min="0" max="1" step="0.001" value="0.217">
        <span class="val" id="offset-val">0.217</span>
    </div>

    <div id="canvas-container"></div>
    <div id="toast"></div>
    <div id="loading"><div class="spin"></div></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        var R = 1.0, H = 2.4, T = 0.08, SEG = 48;

        var toastTimer = null;
        var scene, camera, renderer, controls;
        var mugGroup, bodyMesh, rimMesh, handleMesh;
        var mugTexture = null;
        var magicOn = true;
        var offsetX = 0.217;
        var mugColor = new THREE.Color(0x111111);

        function toast(msg, ms) {
            var el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(function() { el.classList.remove('show'); }, ms || 2500);
        }

        function loading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function applyTexture(src) {
            loading(true);
            new THREE.TextureLoader().load(src, function(tex) {
                tex.wrapS = THREE.RepeatWrapping;
                tex.wrapT = THREE.ClampToEdgeWrapping;
                tex.colorSpace = THREE.SRGBColorSpace;
                tex.anisotropy = renderer.capabilities.getMaxAnisotropy();
                tex.center.set(0.5, 0.5);
                tex.offset.x = offsetX;
                mugTexture = tex;
                updateMug();
                loading(false);
                toast('Design applied!');
            }, undefined, function() {
                loading(false);
                toast('Could not load image — use a local server', 4000);
            });
        }

        function updateOffset() {
            if (!mugTexture) return;
            mugTexture.offset.x = offsetX;
        }

        function updateMug() {
            var m = bodyMesh.material;
            if (magicOn && mugTexture) {
                m.map = mugTexture;
                m.color.set(0xffffff);
                updateOffset();
            } else if (!magicOn) {
                m.map = null;
                m.color.set(0x111111);
            } else {
                m.map = null;
                m.color.copy(mugColor);
            }
            m.needsUpdate = true;

            var c = magicOn ? mugColor.clone() : new THREE.Color(0x111111);
            handleMesh.material.color.copy(c);
            handleMesh.material.needsUpdate = true;
            rimMesh.material.color.copy(c);
            rimMesh.material.needsUpdate = true;
        }

        function build() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe8e4df);

            var aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(28, aspect, 0.1, 50);

            // Your exact camera position
            camera.position.set(12.070, 6.211, -4.133);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.minDistance = 5;
            controls.maxDistance = 20;
            controls.maxPolarAngle = Math.PI / 1.9;
            controls.minPolarAngle = Math.PI / 8;
            controls.target.set(0, H * 0.35, 0);
            controls.update();

            // --- LIGHTS ---
            scene.add(new THREE.HemisphereLight(0xffffff, 0xb0a090, 0.6));
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));

            var key = new THREE.DirectionalLight(0xffffff, 1.5);
            key.position.set(5, 8, 5);
            key.castShadow = true;
            key.shadow.mapSize.set(1024, 1024);
            key.shadow.camera.near = 1;
            key.shadow.camera.far = 20;
            key.shadow.camera.left = -4;
            key.shadow.camera.right = 4;
            key.shadow.camera.top = 4;
            key.shadow.camera.bottom = -4;
            key.shadow.bias = -0.001;
            key.shadow.radius = 4;
            scene.add(key);

            var fill = new THREE.DirectionalLight(0xeeeeff, 0.35);
            fill.position.set(-4, 5, -3);
            scene.add(fill);

            // --- GROUND ---
            var ground = new THREE.Mesh(
                new THREE.PlaneGeometry(20, 20),
                new THREE.MeshStandardMaterial({ color: 0xddd8d0, roughness: 0.9 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // --- ENV MAP ---
            var ec = document.createElement('canvas');
            ec.width = 256; ec.height = 128;
            var cx = ec.getContext('2d');
            var g = cx.createLinearGradient(0, 0, 0, 128);
            g.addColorStop(0, '#c0b8b0');
            g.addColorStop(0.5, '#e0dcd6');
            g.addColorStop(1, '#b0a8a0');
            cx.fillStyle = g;
            cx.fillRect(0, 0, 256, 128);
            var envTex = new THREE.CanvasTexture(ec);
            envTex.mapping = THREE.EquirectangularReflectionMapping;
            scene.environment = envTex;

            // --- MUG ---
            mugGroup = new THREE.Group();
            var mat = new THREE.MeshStandardMaterial({
                color: mugColor, roughness: 0.18, metalness: 0.0, envMapIntensity: 0.3
            });

            var bodyGeo = new THREE.CylinderGeometry(R, R * 0.95, H, SEG, 1, true);
            var uv = bodyGeo.getAttribute('uv');
            for (var i = 0; i < uv.count; i++) uv.setX(i, 1 - uv.getX(i));
            uv.needsUpdate = true;
            bodyMesh = new THREE.Mesh(bodyGeo, mat.clone());
            bodyMesh.castShadow = true;
            mugGroup.add(bodyMesh);

            var ir = R - T;
            var innerGeo = new THREE.CylinderGeometry(ir, ir * 0.95, H - T, SEG, 1, true);
            innerGeo.scale(1, 1, -1);
            var inner = new THREE.Mesh(innerGeo, new THREE.MeshStandardMaterial({
                color: 0xf0ece6, roughness: 0.3, side: THREE.BackSide
            }));
            inner.position.y = T / 2;
            mugGroup.add(inner);

            var bot = new THREE.Mesh(
                new THREE.CircleGeometry(R * 0.95, SEG),
                new THREE.MeshStandardMaterial({ color: 0xe0dcd6, roughness: 0.5 })
            );
            bot.rotation.x = Math.PI / 2;
            bot.position.y = -H / 2;
            bot.receiveShadow = true;
            mugGroup.add(bot);

            var ibot = new THREE.Mesh(
                new THREE.CircleGeometry(ir * 0.95, SEG),
                new THREE.MeshStandardMaterial({ color: 0xf0ece6, roughness: 0.3 })
            );
            ibot.rotation.x = -Math.PI / 2;
            ibot.position.y = -H / 2 + T;
            mugGroup.add(ibot);

            rimMesh = new THREE.Mesh(
                new THREE.TorusGeometry(R - T / 2, T / 2, 12, SEG),
                mat.clone()
            );
            rimMesh.rotation.x = Math.PI / 2;
            rimMesh.position.y = H / 2;
            rimMesh.castShadow = true;
            mugGroup.add(rimMesh);

            var curve = new THREE.CubicBezierCurve3(
                new THREE.Vector3(R * 0.97, H * 0.32, 0),
                new THREE.Vector3(R + 0.7, H * 0.35, 0),
                new THREE.Vector3(R + 0.7, -H * 0.15, 0),
                new THREE.Vector3(R * 0.97, -H * 0.18, 0)
            );
            handleMesh = new THREE.Mesh(
                new THREE.TubeGeometry(curve, 24, 0.1, 10, false),
                mat.clone()
            );
            handleMesh.castShadow = true;
            mugGroup.add(handleMesh);

            mugGroup.position.y = H / 2;
            mugGroup.rotation.y = -Math.PI * 0.25;
            scene.add(mugGroup);
        }

        function bindEvents() {
            document.getElementById('file-input').addEventListener('change', function(e) {
                var f = e.target.files[0];
                if (!f) return;
                var reader = new FileReader();
                reader.onload = function(ev) { applyTexture(ev.target.result); };
                reader.readAsDataURL(f);
            });

            document.getElementById('magic-toggle').addEventListener('change', function(e) {
                magicOn = e.target.checked;
                updateMug();
            });

            document.getElementById('offset-slider').addEventListener('input', function(e) {
                offsetX = parseFloat(e.target.value);
                document.getElementById('offset-val').textContent = offsetX.toFixed(3);
                updateOffset();
            });

            window.addEventListener('resize', function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function loop() {
            requestAnimationFrame(loop);
            controls.update();
            renderer.render(scene, camera);
        }

        build();
        bindEvents();
        loop();
        applyTexture('./image.png');

    </script>
</body>
</html>
